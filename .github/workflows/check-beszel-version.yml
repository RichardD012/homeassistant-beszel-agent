name: Check Beszel Version
on:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight
  workflow_dispatch:  # Allow manual triggering

jobs:
  check-version:
    name: Check for New Beszel Version
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Check for new Beszel version
        id: check_version
        run: |
          # Get the latest release from henrygd/beszel
          LATEST_VERSION=$(curl -s https://api.github.com/repos/henrygd/beszel/releases/latest | jq -r .tag_name)
          
          # Remove 'v' prefix if present
          LATEST_VERSION=${LATEST_VERSION#v}
          
          echo "Latest Beszel version: $LATEST_VERSION"
          
          # Get current version from config.yaml
          CURRENT_VERSION=$(grep version < config.yaml | grep -o '[0-9\.]*')
          
          echo "Current config version: $CURRENT_VERSION"
          
          # Compare versions
          if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ]; then
            echo "New version available: $LATEST_VERSION"
            echo "LATEST_VERSION=$LATEST_VERSION" >> $GITHUB_ENV
            echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
            echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
          else
            echo "Already up to date"
          fi

      - name: Create branch with updated version
        if: env.UPDATE_NEEDED == 'true'
        run: |
          # Create a new branch
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          BRANCH_NAME="update-beszel-to-${{ env.LATEST_VERSION }}"
          git checkout -b $BRANCH_NAME
          
          # Update the version in config.yaml
          sed -i "s/version: \"${{ env.CURRENT_VERSION }}\"/version: \"${{ env.LATEST_VERSION }}\"/" config.yaml
          
          # Commit the change
          git add config.yaml
          git commit -m "Update Beszel version to ${{ env.LATEST_VERSION }}"
          git push origin $BRANCH_NAME

      - name: Create Pull Request
        if: env.UPDATE_NEEDED == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Update Beszel version to ${{ env.LATEST_VERSION }}"
          body: |
            This PR updates the Beszel version from ${{ env.CURRENT_VERSION }} to ${{ env.LATEST_VERSION }}.
            
            The update was automatically generated by the version check workflow.
          branch: "update-beszel-to-${{ env.LATEST_VERSION }}"
          base: main
          draft: false